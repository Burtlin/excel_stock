# Windows 工作排程器設定指南

## 方法 1: 使用 GUI 介面

### 步驟 1: 開啟工作排程器
1. 按 `Win + R`，輸入 `taskschd.msc`，按 Enter
2. 或搜尋「工作排程器」

### 步驟 2: 建立基本工作
1. 右側選擇「建立基本工作」
2. 名稱：`股票數據自動處理`
3. 描述：`每日自動執行股票數據處理`

### 步驟 3: 設定觸發程序
1. 觸發程序：選擇「每天」
2. 開始時間：設定執行時間（例如：上午 9:00）
3. 重複間隔：每 1 天

### 步驟 4: 設定動作
1. 動作：「啟動程式」
2. 程式/指令碼：`D:\github\excel_stock\run_stock_processor.bat`
   （請修改為你的實際路徑）
3. 起始於：`D:\github\excel_stock\`

### 步驟 5: 進階設定（選擇性）
1. 勾選「以最高權限執行」
2. 設定：「不論使用者登入與否均執行」
3. 設定：「停止工作於：1 小時」（避免卡住）

---

## 方法 2: 使用 PowerShell 建立（快速）

```powershell
# 以系統管理員身分執行 PowerShell

# 設定參數
$TaskName = "股票數據自動處理"
$TaskPath = "\MyTasks\"
$ExePath = "D:\github\excel_stock\run_stock_processor.bat"
$WorkingDir = "D:\github\excel_stock"
$TriggerTime = "09:00"  # 執行時間

# 建立觸發程序（每天 9:00）
$Trigger = New-ScheduledTaskTrigger -Daily -At $TriggerTime

# 建立動作
$Action = New-ScheduledTaskAction -Execute $ExePath -WorkingDirectory $WorkingDir

# 建立設定
$Settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable

# 註冊排程工作
Register-ScheduledTask -TaskName $TaskName -TaskPath $TaskPath -Trigger $Trigger -Action $Action -Settings $Settings -Description "每日自動處理股票數據" -User "NT AUTHORITY\SYSTEM" -RunLevel Highest
```

---

## 測試排程

### 手動測試
1. 在工作排程器中找到建立的工作
2. 右鍵點選「執行」
3. 檢查執行結果和日誌

### 檢查日誌
- 執行記錄：`D:\github\excel_stock\logs\stock_processor_YYYYMMDD.log`
- 批次執行記錄：`D:\github\excel_stock\execution.log`

---

## 常見問題

### Q1: 工作沒有執行？
**檢查：**
- 電腦是否開機
- 是否勾選「不論使用者登入與否均執行」
- 是否勾選「以最高權限執行」

### Q2: 執行失敗？
**檢查：**
- 路徑是否正確（使用絕對路徑）
- target.xlsx 是否存在
- 是否有寫入權限
- 查看日誌檔案

### Q3: 如何停用排程？
1. 開啟工作排程器
2. 找到「股票數據自動處理」
3. 右鍵選擇「停用」或「刪除」

---

## 部署檢查清單

- [ ] 已使用 PyInstaller 打包成 exe
- [ ] target.xlsx 放在 exe 同目錄
- [ ] 測試手動執行 exe
- [ ] 測試手動執行 bat 檔
- [ ] 建立 Windows 工作排程
- [ ] 測試排程執行
- [ ] 確認日誌正常寫入

---

## 目錄結構（部署後）

```
D:\github\excel_stock\
├── stock_processor.exe          # 主程式
├── target.xlsx                  # 輸入檔案
├── run_stock_processor.bat      # 執行批次檔
├── execution.log                # 批次執行記錄
├── data/                        # 快取目錄（自動建立）
│   ├── stock_info.json
│   ├── revenue/
│   │   ├── 2330.json
│   │   └── ...
│   └── financial/
│       ├── 2330.json
│       └── ...
└── logs/                        # 日誌目錄（自動建立）
    ├── stock_processor_20251215.log
    ├── stock_processor_20251214.log
    └── ...
```

---

## 更新程式

1. 重新打包：`pyinstaller stock_processor.spec`
2. 複製 `dist\stock_processor.exe` 到部署目錄
3. 不需要重新設定排程
